<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="JavaScript simple transducers" />

    <title>JavaScript embedded effects compiler - JavaScript simple transducers</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79647665-2', 'auto');
  ga('send', 'pageview');

    </script>
  </head>
  <body>
    <div class="container">
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="../">MF.js</a>
        </div>
        <ul class="nav navbar-nav">
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="../archive.html">Blog</a></li>
        </ul>
      </div>
    </nav>
      <div class="container-fluid">
 <h1 id="simpler-transducers">Simpler transducers</h1>
<p>It is, of course, good design practice to split computation into several separate stages. The smaller the stage, the easier it is to reason, develop and maintain. For example we split some computation into 3 stages in functions f, g, k with resulting one is <code>input =&gt; f(g(k(input)))</code> or using Ramda <code>R.comp(f,g,k)</code>. The problem with this approach is intermediate data passed between functions, and each sub-stage should finish its computation completely before passing the result to next stage. The data size they operate with may be large or even infinite if it is some server requests stream. In a case of unlimited data <code>k</code> will never return control. As it is often occurring task, there are many solutions, like nodejs streams with their <code>.pipe()</code> operation adding stream transformer to the chain. Transducers described in this post may be seen as a simpler solution to the problem.</p>
<p>Transducers are easy to compose. In fact they are just functions and function composition is just enough, the expressions above (<code>input =&gt; f(g(k(input)))</code> and <code>R.comp(f,g,k)</code>) are the same for transducers. The resulting transducer is a pipeline of computations receiving data from <em>producer</em> and passing it to <em>consumer</em>. Producer and consumer may do many things, read/write network data, file, DB, or just in-memory array.</p>
<p>The term transducers became popular after introducing them in Clojure in this <a href="http://blog.cognitect.com/blog/2014/8/6/transducers-are-coming">blog post</a> and ported to JavaScript by a few libraries including Ramda. Clojure style transducers are different to the ones described in this post. They transform consumers, which are called reducers in Clojure. Unlike these transducers which transform producers. This distinction makes them much simpler to define in use in ES6 because of generator functions.</p>
<p>Clojure transducers type from the original blog post is:</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span class="co">;;reducing function signature</span>
whatever, input <span class="kw">-&gt;</span> whatever
<span class="co">;;transducer signature</span>
(whatever, input <span class="kw">-&gt;</span> whatever) <span class="kw">-&gt;</span> (whatever, input <span class="kw">-&gt;</span> whatever)</code></pre></div>
<p>There is an earlier paper with the example of transducers transforming producers instead of consumers: <a href="http://okmij.org/ftp/continuations/PPYield/yield-pp.pdf">Lazy v. Yield: Incremental, Linear Pretty-printing</a> in Haskell. And data types there are:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">GenT</span> e m <span class="fu">=</span> <span class="dt">ReaderT</span> (e  <span class="ot">-&gt;</span> m ()) m
<span class="kw">type</span> <span class="dt">Producer</span> m e <span class="fu">=</span> <span class="dt">GenT</span> e m ()
<span class="kw">type</span> <span class="dt">Consumer</span> m e <span class="fu">=</span> e <span class="ot">-&gt;</span> m ()
<span class="kw">type</span> <span class="dt">Transducer</span> m1 m2 e1 e2 <span class="fu">=</span> <span class="dt">Producer</span> m1 e1 <span class="ot">-&gt;</span> <span class="dt">Producer</span> m2 e2</code></pre></div>
<p>To see Consumer there is a reducer from Clojure substitute <code>State e a = s -&gt; m (a, s)</code> into Consumer definition:</p>
<pre><code>Consumer (State whatever) input
= input -&gt; State whatever ()
= input -&gt; whatever -&gt; ((), whatever)
= whatever, input -&gt; whatever</code></pre>
<p>Producer in the paper has a more complex type. Fortunately, this effect is already embedded into JavaScript with ES6 generators. Producers are just any iterable value. It may be some in-memory array or any generator function. Consumer is a function taking iterable value and interpreting it somehow, for example by saving results to file, or JavaScript standard <code>Array.from</code> function stores result in in-memory Array. The approach will work even if the sequence is infinite.</p>
<p>Transducers take input Producer (Iterator) along with other optional parameters and return another Producer-iterator with another computation stacked on top of it.</p>
<p>A typical patter is:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span><span class="op">*</span> <span class="at">f</span>(parameter<span class="op">,</span> input) <span class="op">{</span>
  <span class="co">// local variables storing transducer’s internal</span>
  <span class="co">// state with initial state initialization</span>
  <span class="cf">for</span>(<span class="kw">let</span> I of input) <span class="op">{</span>
    <span class="co">// use current value i along with current state</span>
    <span class="co">// and parameters to compute output value `o`</span>
    <span class="kw">yield</span> o<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>For example <code>map</code> function applying a function to each element is:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span><span class="op">*</span> (fun<span class="op">,</span> input) <span class="op">{</span>
   <span class="cf">for</span>(<span class="kw">let</span> I of input) <span class="op">{</span>
     <span class="kw">yield</span> <span class="at">fun</span>(i)<span class="op">;</span>
   <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Or filter, passing further only elements satisfying some predicate:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span><span class="op">*</span> <span class="at">filter</span>(pred<span class="op">,</span> input) <span class="op">{</span>
  <span class="cf">for</span>(<span class="kw">let</span> I of input) <span class="op">{</span>
     <span class="cf">if</span> (<span class="at">pred</span>(i))
        <span class="kw">yield</span> I<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Hierarchical data may be handled as well; an example is <a href="https://github.com/awto/estree-transducers">estree-transducers</a> project for JavaScript syntax transformation.</p>
<p>But everything is not this simple if there is an asynchronous code at some stage. Likely this is required in Producer because IO in JavaScript is typically asynchronous. It is possible to call <code>next</code> of an iterator in an asynchronous callback, but not <code>yield</code>. This complicates things a lot. However, there is a simple solution for this, namely using <a href="https://github.com/awto/mfjs-compiler">mfjs compiler</a> with asynchronous functions, and simple, readable <code>for-of</code> loops.</p>

 <small>Posted on June 23, 2016</small>

 <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//mfjs.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

      <hr />
      <footer class="footer">
        <p>© 2016 <a href="mailto:vitaliy.akimov@gmail.com">Vitaliy Akimov</a></p>
      </footer>
    </div>
  </body>
</html>
